<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Miosix Drum: Drum Module based on STM32F407VG</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Miosix Drum
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Miosix &amp; Faust on STM32F407VG</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Drum Module based on STM32F407VG </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__home_andrea_STM32_miosix_drum_Readme"></a></p><ul>
<li><a href="https://andreaco.github.io/miosix-drum/">Documentation</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md1"></a>
Introduction</h1>
<p>This project aims at integrating a digital drum synthesizer using Miosix real time OS on an STM32F407VG Discovery Board. To do this, a user interface by means of buttons, sliders, encoders, and an LCD has been implemented to control the synthesizer. Moreover, a serial MIDI input port has been added in order to control the synthesizer externally by using an external sequencer or controller.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Faust Integration</h1>
<p>The audio is implemented by compiling the Faust script inside the <code>src/faust/faust_synth.dsp</code>. It is possible to map custom parameters to the hardware inputs by editing the <code><a class="el" href="parameter__config_8h_source.html">parameter_config.h</a></code> file. Here is a brief example showing the mapping between a Faust parameter and an hardware periphereal. </p><div class="fragment"><div class="line"><span class="comment">// Faust Script</span></div>
<div class="line">...</div>
<div class="line">freq = nentry(<span class="stringliteral">&quot;freq[unit:Hz]&quot;</span>, 440, 20, 20000, 1);</div>
<div class="line">...</div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment">// Parameter Config File</span></div>
<div class="line">...</div>
<div class="line">#define ENCODER1_NAME <span class="stringliteral">&quot;/faust_synth/freq&quot;</span></div>
<div class="line"><span class="preprocessor">#define ENCODER1_MIN 20.0f</span></div>
<div class="line"><span class="preprocessor">#define ENCODER1_MAX 200.0f</span></div>
<div class="line"><span class="preprocessor">#define ENCODER1_LCD_NAME &quot;FRQ&quot;</span></div>
<div class="line">...</div>
</div><!-- fragment --><p> Note that the value currently fetched by the encoder is displayed on the HD44780 LCD, and it is possible to specify a custom name composed by 3 letters. The result is shown in the following figure.</p>
<p><img src="https://user-images.githubusercontent.com/33195819/130662372-f4fb3494-0fb2-4cf9-874b-a74850180bae.jpg" alt="lcd" class="inline"/></p>
<p>It is currently under development in another branch the native integration of the MIDI CC inputs from Faust scripts. Note that if you need a mapping between the faust script and MIDI you should edit the <code>midiProcessing</code> thread function, handling the messages manually.</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Hardware Inputs</h1>
<p>Most of the hardware input classes have been developed by using templated static classes in which we define the pins and other hardware related definitions through the template arguments, and are then initialized by calling an <code>init()</code> function. Each one of those class will later offer a method to retrieve its value by performing specific hardware related actions and setting the relative hardware registers.</p>
<h2><a class="anchor" id="autotoc_md4"></a>
Potentiometer</h2>
<p>The ADC reading has been abstracted through the means of a <code><a class="el" href="class_potentiometer.html">Potentiometer</a></code> static class. This class is templated, and needs the definition of</p><ul>
<li><code>GPIO_BASE</code>: base address of the GPIO group needed</li>
<li><code>PIN</code>: GPIO input pin needed</li>
<li><code>ADC_CHANNEL</code>: ADC channel related to the chosen GPIO pin</li>
</ul>
<p>Below a brief code example explains the usage of the <code><a class="el" href="class_potentiometer.html">Potentiometer</a></code> class. </p><div class="fragment"><div class="line"><span class="comment">// Definition</span></div>
<div class="line"><span class="keyword">typedef</span> <a class="code" href="class_potentiometer.html">Potentiometer&lt;GPIOA_BASE, 2, 2&gt;</a> slider;</div>
<div class="line"><span class="comment">// Initialization</span></div>
<div class="line">slider::init();</div>
<div class="line"><span class="comment">// Reading</span></div>
<div class="line"><span class="keywordtype">float</span> value = slider::read();</div>
<div class="ttc" id="aclass_potentiometer_html"><div class="ttname"><a href="class_potentiometer.html">Potentiometer</a></div><div class="ttdef"><b>Definition:</b> potentiometer.h:31</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md5"></a>
Encoder</h2>
<p>The <code><a class="el" href="class_encoder.html">Encoder</a></code> class is an abstraction to the STM32 timers in encoder mode. Similarly to the <code><a class="el" href="class_potentiometer.html">Potentiometer</a></code> class, this class is templated and needs the definition of:</p><ul>
<li><code>TIM_BASE</code>: timer address to be linked to the encoder.</li>
<li><code>GPIO_BASE</code>: base address of the GPIO group needed.</li>
<li><code>PIN1</code>: pin 1 connected to the encoder.</li>
<li><code>PIN2</code>: pin 2 connected to the encoder.</li>
</ul>
<p>Analogously to the potentiometer class, the initialization of the encoder is performed by calling the static function <code>init()</code>. In the following code snippet a basic usage of this class is shown. </p><div class="fragment"><div class="line"><span class="comment">// Definition</span></div>
<div class="line"><span class="keyword">typedef</span> <a class="code" href="class_encoder.html">Encoder&lt;TIM1_BASE, GPIOE_BASE, 9, 11&gt;</a> encoder;</div>
<div class="line"><span class="comment">// Initialization</span></div>
<div class="line">encoder::init();</div>
<div class="line"><span class="comment">// Simple Reading</span></div>
<div class="line"><span class="keywordtype">float</span> value = encoder::getValue();</div>
<div class="line"><span class="comment">// External Reading</span></div>
<div class="line"><span class="keywordtype">float</span> externalValue1 = 0;</div>
<div class="line"><span class="keywordtype">float</span> externalValue2 = 0;</div>
<div class="line"><span class="keywordflow">if</span> (STATE == PAGE1)</div>
<div class="line">    externalValue1 += encoder::getIncrement();</div>
<div class="line"><span class="keywordflow">if</span> (STATE == PAGE2)</div>
<div class="line">    externalValue2 += encoder::getIncrement();</div>
<div class="ttc" id="aclass_encoder_html"><div class="ttname"><a href="class_encoder.html">Encoder</a></div><div class="ttdef"><b>Definition:</b> encoder.h:16</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md6"></a>
Button</h2>
<p>A class for reading buttons has being defined in a similar fashion as the previous two. The static class <code><a class="el" href="class_button.html">Button</a></code> is templated and needs just the definition of:</p><ul>
<li><code>GPIO_BASE</code> GPIO address to be used.</li>
<li><code>PIN</code>: GPIO pin to read from.</li>
</ul>
<p>As before, we need to initialize it by using the static method <code>init()</code> which simply enables the GPIO RCC timer and set its register to input mode with pull-down option. Here is a code snippet showing its usage: </p><div class="fragment"><div class="line"><span class="comment">// Definition</span></div>
<div class="line"><span class="keyword">typedef</span> <a class="code" href="class_button.html">Button&lt;GPIOD_BASE, 0&gt;</a> button;</div>
<div class="line"><span class="comment">// Initialization</span></div>
<div class="line">button::init();</div>
<div class="line"><span class="comment">// Reading</span></div>
<div class="line"><span class="keywordtype">bool</span> value = button::getState();</div>
<div class="ttc" id="aclass_button_html"><div class="ttname"><a href="class_button.html">Button</a></div><div class="ttdef"><b>Definition:</b> button.h:14</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md7"></a>
MIDI</h2>
<p>The <code><a class="el" href="class_midi_in.html">MidiIn</a></code> class, is simply a wrapper of the class <code>miosix::STM32Serial</code>. It calls the constructor by using the selected standard input to be used which can be chosen by editing the macro <code>MIDI_SERIAL_ID</code> in the <code><a class="el" href="hw__config_8h_source.html">hw_config.h</a></code> header. It then allows reading one byte from it by means of a function <code>read(uint8_t *byte)</code>. To parse the incoming stream of data from the <code><a class="el" href="class_midi_in.html">MidiIn</a></code> port, a <code><a class="el" href="class_midi_parser.html">MidiParser</a></code> class has been implemented. As of now the class have implemented only the parsing of MIDI Note On, Note Off and Control Change messages, which are represented by two different structs respectively. The class is featured with two <code><a class="el" href="class_circular_buffer.html">CircularBuffer</a></code> classes with discarding policy, one for the Note messages and one for the Control Change messages. The size of each of those buffers can be set by editing the <code><a class="el" href="hw__config_8h_source.html">hw_config.h</a></code> file. Here follows two code snippets, one displaying the usage of the <code><a class="el" href="class_midi_in.html">MidiIn</a></code> class, the other the consumption of the data produced by the parser. </p><div class="fragment"><div class="line">uint8_t byte;</div>
<div class="line">uint8_t status = midiIn.read(&amp;<span class="keywordtype">byte</span>); <span class="comment">// Blocking call</span></div>
<div class="line"><span class="keywordflow">if</span> (status &gt; 0)</div>
<div class="line">    midiParser.parseByte(<span class="keywordtype">byte</span>);</div>
</div><!-- fragment --> <div class="fragment"><div class="line"> <span class="comment">// MIDI Note consumption</span></div>
<div class="line"><span class="keywordflow">if</span> (midiParser.isNoteAvaiable()) {</div>
<div class="line">    <a class="code" href="struct_midi_note.html">MidiNote</a> note = midiParser.popNote();</div>
<div class="line">    <span class="keywordflow">if</span> (note.msgType == MidiNote::NOTE_ON)</div>
<div class="line">        synth.gateOn();</div>
<div class="line">    <span class="keywordflow">if</span> (note.msgType == MidiNote::NOTE_OFF)</div>
<div class="line">        synth.gateOff();</div>
<div class="line">}</div>
<div class="line"><span class="comment">// MIDI CC consumption</span></div>
<div class="line"><span class="keywordflow">if</span> (midiParser.isCCAvaiable()) {</div>
<div class="line">    <a class="code" href="struct_control_change.html">ControlChange</a> cc = midiParser.popCC();</div>
<div class="line">    <span class="keywordflow">if</span>(cc.controlNumber == 42)</div>
<div class="line">        synth.setFoo(cc.value);</div>
<div class="line">    <span class="keywordflow">if</span>(cc.controlNumber == 33)</div>
<div class="line">        synth.setBar(cc.value);</div>
<div class="line">}</div>
<div class="ttc" id="astruct_control_change_html"><div class="ttname"><a href="struct_control_change.html">ControlChange</a></div><div class="ttdef"><b>Definition:</b> midi_parser.h:34</div></div>
<div class="ttc" id="astruct_midi_note_html"><div class="ttname"><a href="struct_midi_note.html">MidiNote</a></div><div class="ttdef"><b>Definition:</b> midi_parser.h:18</div></div>
</div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
